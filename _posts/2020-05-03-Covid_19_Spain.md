---
layout: post
title: COVID_19 Análisis por CC.AA. en España
subtitle: Compararando evolución diaria de las CCAA en Fallecidos e Ingresados en UCI
image: /img/covid.jpg
tags: [R,shiny,covid]
---
 
### Mapa para visualizar las diferencias por CCAA en el impacto del Covid_19: 

Tambié se ha utilizado la librería **rgdal** para importar las formas de las Comunidades y la librería **broom** para convertir estas formas en la estructura de datos que necesitamos.

**Cifras totales a 1 de Mayo de 2020:** 

Datos de Fallecidos totales: 
<img src="https://i.ibb.co/x5jdm81/regions.png" alt="drawing" height="550" width="750"/>
<br>

Datos de Fallecidos por 1.000.000 habitantes: 
<img src="https://i.ibb.co/2tNJqKK/regions-x-millon.png" alt="drawing" height="550" width="750"/>

* * *

### Gráficos para visualizar las diferencias por CCAA en la evolución diaria del Covid_19:

Separamos los datos de cada CCAA, para poder trabajar de forma independiente en cada una de ellas. Para ello, con la función **nest()** de la librería *tidyr* vamos a crear una lista con tantos elemntos como CCAA hay.

```{r}
# data_nested <- data_0 %>%
          mutate(Comunidad=CCAA,
                  Fecha=as.Date(dmy(Fecha))) %>%
          tidyr::nest(-CCAA)
```
Después, la función **map()** de la librería *purrr* nos permite repetir cualquier acción para todos los elementos de la lista. En este caso, vamos a crear un gráfico para cada CCAA con muy poco código.

```{r}
# plots <- purrr::map2(data_nested$data, data_nested$CCAA, .f = function(x,y) { data.frame(x) %>%
    mutate(Uci_MA_5 = zoo::rollapply(Uci_dia,list(-1:-5),mean,fill=NA),
           Death_MA_5 = zoo::rollapply(Muertos_dia,list(-1:-5),mean,fill=NA)) %>%
    na.omit() %>%
    mutate(Day_Uci_Over_Max=Uci_MA_5/max(Uci_MA_5),
           Day_Death_Over_Max=Death_MA_5/max(Death_MA_5)) %>%
    dplyr::select(Fecha, Day_Uci_Over_Max, Day_Death_Over_Max) %>%
    tidyr::pivot_longer(-Fecha, names_to="Variable", values_to="Porcentaje_sobre_max") %>%
    ggplot(aes(x=Fecha, y=Porcentaje_sobre_max, color=Variable)) +
    geom_line(aes(group=Variable), size=1) + 
    scale_y_continuous(labels=percent_format()) + 
    labs(x="Fecha", y="% sobre Máximo", title=y, caption="5 día Media Movil") + 
    theme(legend.title=element_blank(), axis.text.x=element_text(colour="gray30",size=9,angle=45, hjust=1), panel.background=element_rect(fill="gray98"), panel.grid.major=element_line(colour="gray92")) })
```
**El gráfico nos muestra los casos diarios de Fallecidos e Ingresados en UCI en porcentaje respecto al día en que cada CCAA alcanzó su máximo de Fallecidos o de ingresos en UCI.**

Para una Comunidad: 
<img src="https://i.ibb.co/M8PPjtf/plot-evo-cat.png" alt="drawing" height="500" width="600"/>

<br>
Para todas: 
<img src="https://i.ibb.co/gtzpVLM/plot-evo-ccaa.png" alt="drawing" width="1200"/>

* * *

#### Gráficos animados...

![Alt Text](https://i.imgur.com/bovzk1A.gif)


#### Feel free to contact me if you need any help for your Company...
